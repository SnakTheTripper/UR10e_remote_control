<!DOCTYPE html>
<head>
    <title>UR10 TCP Controller</title>
    <style>
        .table-container-center {
            display: flex;
            justify-content: center;
        }
        .tcp-row {
            display: grid;
            grid-template-columns: 1fr 0.5fr 1fr 0.5fr; /* Adjust these fractions based on your needs */
            grid-gap: 16px; /* Space between each cell */
            text-align: center;
            border: 1px solid #000;
            padding: 8px;
        }
        .parameter_row {
            display: grid;
            grid-template-columns: 1fr 0.5fr 2fr 0.5fr; /* Adjust these fractions based on your needs */
            grid-gap: 16px; /* Space between each cell */
            text-align: center;
            border: 1px solid #000;
            padding: 8px;
        }
        .joint-slider-wrapper {
            position: relative;
        }
        .current-slider, .target-slider {
            position: absolute;
            text-align: center;
            width: 75%;
            left: 11%;
        }
        .current-slider {
            z-index: 1;
            opacity: 0.75;
        }
        .target-slider {
            z-index: 2;
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        var current_tcp_positions = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];   // not used currently but updated
        var tcp_position = []
        var program_list = []

        function r2d(radians) {
            return radians * (180 / Math.PI);

        }
        function updateValue(inputElement, outputElementId) {   // value from, value to
            const value = inputElement.value;
            console.log('trying to update element with ID: ', outputElementId)
            document.getElementById(outputElementId).innerText = parseFloat(value).toFixed(2);
            console.log('updated.')
        }

        function randomizeTcpValues() {
            const positionFields = ['tcp_0', 'tcp_1', 'tcp_2'];     // x  y  z
            const angleFields = ['tcp_3', 'tcp_4', 'tcp_5'];        // rx ry rz

            for (const field of positionFields) {
                const randomValue = (Math.floor(Math.random() * (1000 - 100 + 1)) + 100) / 1000;  // Random between 100 and 1000
                document.getElementById(field).value = randomValue;
                updateValue(document.getElementById(field), `output_${field}`);
            }

            for (const field of angleFields) {
                const randomAngle = Math.floor(Math.random() * (359 - (-359) + 1)) - 359;  // Random between -359 and 359
                const randomRadian = randomAngle;
                document.getElementById(field).value = randomRadian;
                updateValue(document.getElementById(field), `output_${field}`);
            }
        }
        function setHomePosition() {
            // Set the home position values [0 -90 0 -90 0 0] for each joint
            const homePosition = [0, 0, 500, 0, 0, 0];        // i hope it's in mm
            {% for i in range(6) %}
                document.getElementById("tcp_{{ i }}").value = homePosition[i]
                updateValue(document.getElementById("tcp_{{ i }}"), homePosition[i])
            {% endfor %}
        }
        function updateCurrentPosition(box, position) {
            const slider = document.getElementById(`current_tcp_${box}`);
            slider.value = r2d(position);
            current_tcp_positions[box] = r2d(position);
            updateValue(slider, `current_tcp_${box}`);
            document.getElementById(`current_tcp_box_${box}`).innerText = r2d(position).toFixed(2); // This line is new
        }

        function collectTCPValues() {
            const tcp_positions = [];
            for (let i = 0; i < 6; i++) {
                tcp_positions.push(parseFloat(document.getElementById(`tcp_${i}`).value));
            }
            return tcp_positions;
        }

        socket = io.connect('http://10.0.0.225:5000');

        socket.on('connect', function() {
            console.log('Websocket connected!');
        });

        window.onload = function () {
            initialize_sliders()
        }



        function updateTable(program_list) {
            let tableBody = document.getElementById('waypointTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = "";  // Clear existing rows

            for (let i = 0; i < program_list.length; i++) {
                let row = tableBody.insertRow();
                let cell1 = row.insertCell(0);
                let cell2 = row.insertCell(1);
                let cell3 = row.insertCell(2);

                const jointPositionsInDegrees = program_list[i][1].map((pos) => r2d(pos).toFixed(0));
                cell1.innerHTML = jointPositionsInDegrees.toString();

                cell2.innerHTML = r2d(program_list[i][2]).toFixed(0);  // Speed
                cell3.innerHTML = r2d(program_list[i][3]).toFixed(0);  // Acceleration
            }
        }



        function handleSend() {
            const tcp_positions = [];
            for (let i = 0; i < 6; i++) {
                tcp_positions.push(parseFloat(document.getElementById(`tcp_output_${i}`).value));
            }
            const v = parseFloat(document.getElementById('tcp_speed').value);
            const a = parseFloat(document.getElementById('tcp_accel').value);

            socket.emit('button_press', {action: 'send',
            target_tcp_positions: tcp_positions,
            tcp_speed: v,
            tcp_accel: a})
        }

        // button functions

        function addToList() {
            socket.emit('button_press', {action: 'addToList'})
        }
        function deleteFromList() {
            socket.emit('button_press', {action: 'deleteFromList'})
        }
        function clearList() {
            socket.emit('button_press', {action: 'clearList'})
        }
        function runProgram() {
            socket.emit('button_press', {action: 'runProgram'})
        }

        // socket.on section ()

        socket.on('updateTable', function(data) {
            program_list = data.program_list
            updateTable(program_list)
        });
        socket.on('program_end', function(data) {
            alert('Program Ran Successfully')
        });
        socket.on('no_program_to_run', function(data) {
            alert('No program to run...')
        });

        socket.on('update_current', function(data) {
            const positions = data.positions;

            for (let i = 0; i < 6; i++) {
                updateCurrentPosition(i, positions[i]);
                //console.log("Updating", `current_tcp_${i}`, "with", positions[i]);
            }
        });

        socket.on('update_target_positions', function(data) {
            let target_positions = data.target_tcp_positions;

            for (let i = 0; i < 6; i++) {
                const tcpSlider = document.getElementById(`tcp_${i}`);
                tcpSlider.value = target_positions[i];
                updateValue(tcpSlider, `output_tcp_${i}`);
            }

            let target_speed = data.speedL;
            let target_accel = data.accelL;

            console.log(target_speed)
            console.log(target_accel)

            const tcp_speed = document.getElementById('tcp_speed');
            const tcp_accel = document.getElementById('tcp_accel');
            tcp_speed.value = target_speed;  // Fixed this to match your HTML IDs
            tcp_accel.value = target_accel;  // Fixed this to match your HTML IDs
            updateValue(tcp_speed, 'output_tcp_speed');  // Assuming you'll add these output elements
            updateValue(tcp_accel, 'output_tcp_accel');  // Assuming you'll add these output elements
        });


        socket.on('target_slider_init', function (data) {      // Initializes target position sliders with current position values for aesthetics
            let current_jp = data.current_tcp_positions
            program_list = data.program_list
            for (let i = 0; i < current_jp.length; i++) {
                const jointSlider = document.getElementById(`tcp_${i}`);
                jointSlider.value = r2d(current_jp[i]);
                updateValue(jointSlider, `tcp_${i}`);
            }
            updateTable(program_list)
        });




        // allows current position flow for a second for initialization

        window.onload = function () {
            socket.emit('set_moving', { is_moving: true });
        }
        function keepAlive() {
            socket.emit('keep_alive', {data: 'Client is alive'});
        }

        // keep alive

        socket.on('keep_alive', function(data) {
            const msg = data.message
            console.log(msg)
        });
        setInterval(keepAlive, 10000)
    </script>
</head>
<body class="table-container-center">
    <form action="/" method="post">
        <table>
            <caption>TCP Control</caption>
            <tr class="tcp-row">
                <th scope="row"><label>X:</label></th>
                <td><span id="current_tcp_0">0.00</span></td>
                <td>
                    <input type="number" id="tcp_0" name="tcp_x" min="-360" max="360" step="1" value="{{ request.form['tcp_x'] | default(200) }}" oninput="updateValue(this, 'output_tcp_0')">
                </td>
                <td><span id="output_tcp_0">0.00</span></td>
            </tr>
            <tr class="tcp-row">
                <th scope="row"><label>Y:</label></th>
                <td><span id="current_tcp_1">0.00</span></td>
                <td>
                    <input type="number" id="tcp_1" name="tcp_y" min="-360" max="360" step="1" value="{{ request.form['tcp_y'] | default(200) }}" oninput="updateValue(this, 'output_tcp_1')">
                </td>
                <td><span id="output_tcp_1">0.00</span></td>
            </tr>
            <tr class="tcp-row">
                <th scope="row"><label>Z:</label></th>
                <td><span id="current_tcp_2">0.00</span></td>
                <td>
                    <input type="number" id="tcp_2" name="tcp_z" min="-360" max="360" step="1" value="{{ request.form['tcp_z'] | default(200) }}" oninput="updateValue(this, 'output_tcp_2')">
                </td>
                <td><span id="output_tcp_2">0.00</span></td>
            </tr>
            <tr class="tcp-row">
                <th scope="row"><label>Rx:</label></th>
                <td><span id="current_tcp_3">0.00</span></td>
                <td>
                    <input type="number" id="tcp_3" name="tcp_rx" min="-360" max="360" step="1" value="{{ request.form['tcp_rx'] | default(200) }}" oninput="updateValue(this, 'output_tcp_3')">
                </td>
                <td><span id="output_tcp_3">0.00</span></td>
            </tr>
            <tr class="tcp-row">
                <th scope="row"><label>Ry:</label></th>
                <td><span id="current_tcp_4">0.00</span></td>
                <td>
                    <input type="number" id="tcp_4" name="tcp_ry" min="-360" max="360" step="1" value="{{ request.form['tcp_ry'] | default(200) }}" oninput="updateValue(this, 'output_tcp_4')">
                </td>
                <td><span id="output_tcp_4">0.00</span></td>
            </tr>
            <tr class="tcp-row">
                <th scope="row"><label>Rz:</label></th>
                <td><span id="current_tcp_r5">0.00</span></td>
                <td>
                    <input type="number" id="tcp_5" name="tcp_rz" min="-360" max="360" step="1" value="{{ request.form['tcp_rz'] | default(200) }}" oninput="updateValue(this, 'output_tcp_5')">
                </td>
                <td><span id="output_tcp_5">0.00</span></td>
            </tr>

            <tr class="tcp-row">
                <th scope="row" style="text-align: center"><label>TCP speed: </label></th>
                <td></td>
                <td>
                    <input type="number" id="tcp_speed" name="tcp_speed" min="1" max="5" step="0.1" value="{{ request.form['tcp_' ~ i] | default(0.5) }}">
                </td>
            </tr>
            <tr class="tcp-row">
                <th scope="row" style="text-align: center"><label>TCP acceleration: </label></th>
                <td></td>
                <td>
                    <input type="number" id="tcp_accel" name="tcp_accel" min="1" max="5" step="0.1" value="{{ request.form['tcp_' ~ i] | default(0.5) }}">
                </td>
            </tr>
        </table><br>
        <button type="button" onclick="handleSend()">SEND</button>
        <button type="button" onclick="randomizeTcpValues()">Randomize TCP Values</button>
        <button type="button" onclick="setHomePosition()">Set Home Position</button>

        <br><br><br><br>

        <button type="button" onclick="addToList()">Add</button>
        <button type="button" onclick="deleteFromList()">Delete last entry</button>
        <button type="button" onclick="clearList()">CLEAR</button>
        <button type="button" onclick="runProgram()">Run Program</button>
        <table id="waypointTable">
            <thead>
                <tr>
                    <th>Joint Positions</th>
                    <th>Speed</th>
                    <th>Acceleration</th>
                </tr>
            </thead>
            <tbody>
                <!-- Program Rows will go here -->
            </tbody>
        </table>


    </form>
</body>
